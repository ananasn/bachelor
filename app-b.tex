\chapter{Листинг модуля генерации G-кода}
\label{app:gcodes}
{\singlespacing
\begin{lstlisting}[
    language=python]
# -*- coding: utf-8 -*-
import copy

class Generator(object):
    
    def __init__(self,heightmap,h,w,
                offset,norm,name):
        self.name = name
        self.norm = norm
        self.h = h
        self.w = w
        self.depth = self._depth(heightmap,h,w)
        self.offset = offset
        self.offset_counter = 0.0
        self.start_block = [
                            '%','O01', 'G90', 'G21', 'G00X0Y0',
                            'G00Z' + str(0), 
                            'G00Z' + str(2),
                            'G91', 'F300.0S6000M03'
                            ]
        #блок для нечетных строк
        self.body_block_unevenstr = [['G01X-', ''], 
        												['G01Z-', ''],
        												['G01Z', '']]
        #блок для четных строк
        self.body_block_evenstr = [['G01X', ''],
        											 ['G01Z-', ''],
        											 ['G01Z', '']]
        self.end_block = ['G00X0Y0', 'M05', 'M02', '%']
      
    def generate(self):
        """Generate G-codes list"""
        res = []
        for i in xrange(self.h):
            for j in xrange(self.w):
                if (round(float(self.depth[i][j]), 1) == 0.0 ):
                    self.offset_counter += self.offset
                    continue
                if i%2 == 0:
                    res += self._substitution(
                        self.body_block_evenstr,
                        i, j)
                else:
                    res += self._substitution(
                        self.body_block_unevenstr,
                        i, j)
                self.offset_counter = self.offset
            self.offset_counter = self.offset
            res += ['G01Y' + str(self.offset)]
        for item in self.end_block: res.append(item)
        for item in self.start_block[::-1]: res.insert(0,item)
        return res
        
    #подставляем глубину в списки вида  ['G01Z','']
    def _substitution(self,block,i,j):
        block = copy.deepcopy(block)
        for item in block:
            if (isinstance(item,list) and 
                    item[0].startswith('G01Z')):
                item[1] = str(float(self.depth[i][j]) + 2)
            else:
                item[1] = str(self.offset_counter)
        return block
        
    def write(self,gcode_list):
        """Writes G-codes in fie g_codes.txt"""
        with open(self.name, 'w') as f:
            for item in gcode_list:
                if len(item) == 1:
                    f.write(item + '\n')
                else:
                    f.write(''.join(item) + '\n')
                    
    def _depth(self,heightmap,h,w):
        with open('temp.txt','w') as f:
            f = heightmap
        depth = []
        for i in xrange(h): 
            depth.append( [ str(self.norm - float(heightmap[i*w + j])) \
                             for j in xrange(w) ])
        return depth
\end{lstlisting}
}
